# Python Analysis Script for Nanopore Metagenomics

This document provides a guide to using the Python script (`metagenomics_analysis.py`) for post-processing and analyzing data from the air microbiome nanopore sequencing pipeline.

## üß¨ Overview

This script provides several functions for data extraction, processing, visualization, and reporting, which can be invoked using specific commands.

## üõ†Ô∏è Prerequisites

- Python 3.9+
- The required Python libraries must be installed. You can install them using pip:
  ```bash
  pip install pandas numpy matplotlib seaborn biopython jinja2 plotly
  ```
- Your analysis results (e.g., NanoStat reports, Kraken2 reports) and read files (.fastq format) must be available in organized directories.

## üöÄ Script Usage

The script is command-line driven and uses sub-commands for different tasks. The general usage pattern is:

```bash
python metagenomics_analysis.py <task> [options]
```

Below are the details for each available `<task>`.

---

### 1. `nanostat`: Extract Read Metrics

This task parses NanoStat output files to create a summary table of read quality metrics.

- **Input**: A directory containing NanoStat report files (e.g., `filtered_barcode01_passed_nanostats.txt`).
- **Output**: A CSV file summarizing the mean read length, median read length, N50, and total number of reads for each sample.

**Command:**
```bash
python metagenomics_analysis.py nanostat \
  --input_dir /path/to/nanostat_results/ \
  --output_file ./analysis_summary/read_metrics.csv
```

---

### 2. `length_histogram`: Plot Read Length Distribution

This task generates a publication-quality read length histogram from a single FASTQ file.

- **Input**: A FASTQ file (`.fastq`).
- **Output**: A PNG image of the histogram, saved to the specified output directory.

**Command:**
```bash
python metagenomics_analysis.py length_histogram \
  --input_file /path/to/filtered_reads/barcode01.fastq \
  --output_dir ./analysis_summary/plots/
```

---

### 3. `kraken_abundance`: Summarize Taxonomic Abundance

This task processes all Kraken2 reports in a directory to calculate the relative abundance of phyla and genera. It filters for taxa with >= 1% relative abundance.

- **Input**: A directory containing Kraken2 report files (e.g., `report_barcode01.txt`).
- **Output**: A single CSV file containing the relative abundance data for all samples.

**Command:**
```bash
python metagenomics_analysis.py kraken_abundance \
  --input_dir /path/to/kraken2_reports/ \
  --output_file ./analysis_summary/kraken_relative_abundance.csv
```

---

### 4. `kraken_counts`: Summarize Read Counts

This task processes Kraken2 reports to get the total number of reads assigned to the phylum and genus levels for each sample.

- **Input**: A directory containing Kraken2 report files.
- **Output**: A CSV file containing the raw read counts for phyla and genera per sample.

**Command:**
```bash
python metagenomics_analysis.py kraken_counts \
  --input_dir /path/to/kraken2_reports/ \
  --output_file ./analysis_summary/kraken_read_counts.csv
```

---

### 5. `plot_counts`: Visualize Classified Read Counts

This task creates bar plots from a summary CSV file to visualize read counts across different classification levels.

- **Input**: A CSV file, typically generated by combining the outputs of the `nanostat` and `kraken_counts` tasks. The CSV must have a 'Sample ID' column.
- **Output**: A set of PNG bar plots, one for each "Location" found in the Sample IDs.

**Command:**
```bash
python metagenomics_analysis.py plot_counts \
  --input_file ./analysis_summary/combined_read_counts.csv \
  --output_dir ./analysis_summary/plots/
```

---

### 6. `create_report`: Generate Final HTML Report

This is the final step. It scans a pipeline output directory and generates a comprehensive, interactive HTML report summarizing all results.

- **Input**: The main output directory of your entire bioinformatics pipeline (which should contain subdirectories for `processing/nanostat`, `processing/kraken2_read_classification`, etc.).
- **Output**: A single HTML report file.

**Command:**
```bash
python metagenomics_analysis.py create_report \
  --input_dir /path/to/your/project_results/ \
  --output_file ./FINAL_REPORT.html
```

## üìù Recommended Workflow

Here is a recommended order of operations for using these scripts after running the main pipeline:

1.  **Extract initial metrics from your results:**
    ```bash
    # Create a directory for your analysis summaries
    mkdir -p analysis_summary/plots

    # Get read quality stats from NanoStat
    python metagenomics_analysis.py nanostat \
      --input_dir /path/to/project/processing/nanostat/ \
      --output_file analysis_summary/nanostat_summary.csv

    # Get taxonomic read counts from Kraken2
    python metagenomics_analysis.py kraken_counts \
      --input_dir /path/to/project/processing/kraken2_read_classification/ \
      --output_file analysis_summary/kraken_counts.csv

    # Get relative abundance from Kraken2
    python metagenomics_analysis.py kraken_abundance \
      --input_dir /path/to/project/processing/kraken2_read_classification/ \
      --output_file analysis_summary/kraken_abundance.csv
    ```

2.  **Create visualizations:**
    ```bash
    # Generate a read length histogram for a specific sample
    python metagenomics_analysis.py length_histogram \
      --input_file /path/to/project/processing/nanofilt/filtered_barcode01_passed.fastq \
      --output_dir analysis_summary/plots/
    
    # If you have a combined CSV, plot the read counts
    # You might need to manually merge nanostat_summary.csv and kraken_counts.csv first
    # python metagenomics_analysis.py plot_counts --input_file combined_metrics.csv --output_dir analysis_summary/plots/
    ```

3.  **Generate the final, all-in-one report:**
    ```bash
    python metagenomics_analysis.py create_report \
      --input_dir /path/to/your/project_results/ \
      --output_file FINAL_REPORT.html
    ```

This consolidated script and guide should significantly streamline your data analysis and reporting process.
